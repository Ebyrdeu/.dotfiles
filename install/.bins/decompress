#!/usr/bin/env bash
set -euo pipefail


# Colors
C_RESET='\033[0m'
C_OK='\033[0;32m'
C_WARN='\033[1;33m'
C_ERR='\033[0;31m'
C_HEAD='\033[1;36m'

# Helpers
say()  { printf "%b[INFO]%b %s\n" "$C_HEAD" "$C_RESET" "$*"; }
ok()   { printf "%b[OK]%b %s\n" "$C_OK"   "$C_RESET" "$*"; }
warn() { printf "%b[WARN]%b %s\n" "$C_WARN" "$C_RESET" "$*"; }
err()  { printf "%b[ERR]%b %s\n" "$C_ERR"  "$C_RESET" "$*" >&2; }

# Usage
if [[ -z "${1:-}" ]]; then
    echo "Usage:   $(basename "$0") <file> [destination_folder]"
    echo "Example: $(basename "$0") archive.tar.gz"
    echo "Example: $(basename "$0") archive.tar.gz ./output_dir"
    exit 1
fi

FILE="$1"
DEST_DIR="${2:-}"

# Check file existence
if [[ ! -f "$FILE" ]]; then
    err "File '$FILE' not found."
    exit 1
fi

# Create Destination if provided
if [[ -n "$DEST_DIR" ]]; then
    mkdir -p "$DEST_DIR"
    say "Extracting to: $DEST_DIR"
else
    say "Extracting to current directory..."
fi

# Detect helpers
HAS_PV=false
if command -v pv >/dev/null 2>&1; then HAS_PV=true; fi

# Function to run tar with PV if available
# Usage: extract_tar <algo_flag> <parallel_prog_name>
extract_tar() {
    local tar_flag="$1" # e.g., z, j, J
    local parallel_prog="$2" # e.g., pigz, pbzip2

    local tar_cmd="tar -x${tar_flag}f -"

    # Handle Destination
    if [[ -n "$DEST_DIR" ]]; then
        tar_cmd="tar -x${tar_flag}f - -C \"$DEST_DIR\""
    fi

    # 1. Try Parallel + Progress
    if [[ -n "$parallel_prog" ]] && command -v "$parallel_prog" >/dev/null 2>&1; then
        say "Using $parallel_prog (multi-core) optimization"
        if [[ "$HAS_PV" == "true" ]]; then
            pv "$FILE" | $parallel_prog -d | eval "$tar_cmd"
        else
            # Parallel but no PV
            # tar -I is cleaner than pipes if no pv
            local direct_cmd="tar -I $parallel_prog -xf \"$FILE\""
            [[ -n "$DEST_DIR" ]] && direct_cmd="$direct_cmd -C \"$DEST_DIR\""
            eval "$direct_cmd"
        fi

    # 2. Standard + Progress
    elif [[ "$HAS_PV" == "true" ]]; then
        # Rely on tar's internal flags (z/j/J) but pipe via PV
        # Note: We pipe PV into tar, so we use '-' as filename
        pv "$FILE" | eval "$tar_cmd"

    # 3. Basic fallback
    else
        local basic_cmd="tar -x${tar_flag}f \"$FILE\""
        [[ -n "$DEST_DIR" ]] && basic_cmd="$basic_cmd -C \"$DEST_DIR\""
        eval "$basic_cmd"
    fi
}

# ============================================================
# Extraction Logic
# ============================================================

# Get mimetype or extension logic
EXT="${FILE##*.}"
LOWER_EXT=$(echo "$EXT" | tr '[:upper:]' '[:lower:]')

# Handle double extensions (tar.gz)
if [[ "$FILE" == *".tar.gz" || "$FILE" == *".tgz" ]]; then
    extract_tar "z" "pigz"

elif [[ "$FILE" == *".tar.bz2" || "$FILE" == *".tbz2" ]]; then
    extract_tar "j" "pbzip2"

elif [[ "$FILE" == *".tar.xz" || "$FILE" == *".txz" ]]; then
    # pixz is sometimes available, but xz -T0 is standard in modern tar
    # We'll use standard xz flag 'J'
    extract_tar "J" "xz"

elif [[ "$FILE" == *".tar" ]]; then
    extract_tar "" ""

elif [[ "$LOWER_EXT" == "zip" ]]; then
    if ! command -v unzip >/dev/null 2>&1; then err "Missing 'unzip'."; exit 1; fi
    if [[ -n "$DEST_DIR" ]]; then
        unzip "$FILE" -d "$DEST_DIR"
    else
        unzip "$FILE"
    fi

elif [[ "$LOWER_EXT" == "7z" ]]; then
    if ! command -v 7z >/dev/null 2>&1; then err "Missing 'p7zip' or '7z'."; exit 1; fi
    # 7z syntax: x file -o{dir} (no space allowed after -o)
    if [[ -n "$DEST_DIR" ]]; then
        7z x "$FILE" "-o$DEST_DIR"
    else
        7z x "$FILE"
    fi

elif [[ "$LOWER_EXT" == "rar" ]]; then
    if ! command -v unrar >/dev/null 2>&1; then err "Missing 'unrar'."; exit 1; fi
    if [[ -n "$DEST_DIR" ]]; then
        unrar x "$FILE" "$DEST_DIR/"
    else
        unrar x "$FILE"
    fi

elif [[ "$LOWER_EXT" == "zst" ]]; then
    if ! command -v zstd >/dev/null 2>&1; then err "Missing 'zstd'."; exit 1; fi
    # zstd usually decompresses single files, but often used for tar.zst
    if [[ "$FILE" == *".tar.zst" ]]; then
        if [[ -n "$DEST_DIR" ]]; then
            zstd -d "$FILE" --stdout | tar -xf - -C "$DEST_DIR"
        else
            zstd -d "$FILE" --stdout | tar -xf -
        fi
    else
        # Single file
        zstd -d "$FILE"
    fi

elif [[ "$LOWER_EXT" == "gz" ]]; then
    # Single GZ file
    if command -v pigz >/dev/null 2>&1; then
        pigz -d -k "$FILE" # -k keeps original
    else
        gunzip -k "$FILE"
    fi

else
    err "Unknown format: $FILE"
    err "Supported: tar.gz, tar.bz2, tar.xz, zip, 7z, rar, zst, gz"
    exit 1
fi

ok "Done."
