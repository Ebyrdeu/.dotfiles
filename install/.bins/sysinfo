#!/usr/bin/env bash

# Colors for a clean, modern look
C_HEAD='\033[1;36m'
C_LABEL='\033[1;32m'
C_RESET='\033[0m'

# 1. OS Information
if [[ -r /etc/os-release ]]; then
    . /etc/os-release
    os="${NAME:-Linux} ($(uname -m))"
else
    os="$(uname -s) $(uname -m)"
fi

# 2. Host Model
host_model="Unknown"
[[ -r /sys/class/dmi/id/product_name ]] && host_model="$(< /sys/class/dmi/id/product_name)"
[[ -r /sys/class/dmi/id/product_version ]] && host_model+=" $(< /sys/class/dmi/id/product_version)"

# 3. Uptime
up_s=$(awk '{print int($1)}' /proc/uptime)
hours=$((up_s/3600)) mins=$(((up_s%3600)/60))
uptime_str=""
((hours>0)) && uptime_str+="${hours}h "
((mins>0)) && uptime_str+="${mins}m"

# 4. Package Count (Fedora vs Arch Detection)
pkg_count="N/A"
if command -v pacman >/dev/null 2>&1; then
    # Arch Linux
    pkg_count="$(pacman -Q 2>/dev/null | wc -l) (pacman)"
fi

# 5. CPU & GPU
cpu_model="$(awk -F: '/model name/ {print $2; exit}' /proc/cpuinfo | xargs)"
cpu_cores="$(grep -c '^processor' /proc/cpuinfo)"
cpu="${cpu_model:-N/A} (${cpu_cores} cores)"

gpu="N/A"
if command -v nvidia-smi >/dev/null 2>&1; then
    gpu="$(nvidia-smi --query-gpu=name --format=csv,noheader | head -n1)"
elif command -v lspci >/dev/null 2>&1; then
    gpu="$(lspci | grep -iE 'vga|3d|display' | cut -d: -f3 | xargs | sed 's/\[.*\]//g')"
fi


# 6. Memory & Storage
mt=$(awk '/MemTotal:/ {print $2}' /proc/meminfo)
ma=$(awk '/MemAvailable:/ {print $2}' /proc/meminfo)
mu=$((mt - ma))
mem_p=$(( mu * 100 / mt ))

# Use awk to handle the math and formatting to avoid locale decimal errors
mem_used_gb=$(awk "BEGIN {printf \"%.1f\", $mu/1024/1024}")
mem_total_gb=$(awk "BEGIN {printf \"%.1f\", $mt/1024/1024}")

mem_str="${mem_used_gb} GiB / ${mem_total_gb} GiB (${mem_p}%)"

# 7. Disk Usage (Fixed)
read -r d_total d_used d_percent <<<"$(df -h / | awk 'NR==2{print $2,$3,$5}')"

# --- OUTPUT ---
echo -e "${C_HEAD}------------------------------------------${C_RESET}"
printf "${C_LABEL}%-12s${C_RESET} %s\n" "OS:"       "$os"
printf "${C_LABEL}%-12s${C_RESET} %s\n" "Host:"     "$host_model"
printf "${C_LABEL}%-12s${C_RESET} %s\n" "Kernel:"   "$(uname -r)"
printf "${C_LABEL}%-12s${C_RESET} %s\n" "Uptime:"   "$uptime_str"
printf "${C_LABEL}%-12s${C_RESET} %s\n" "Packages:" "$pkg_count"
printf "${C_LABEL}%-12s${C_RESET} %s\n" "Desktop:"  "${XDG_CURRENT_DESKTOP:-N/A}"
printf "${C_LABEL}%-12s${C_RESET} %s\n" "CPU:"      "$cpu"
printf "${C_LABEL}%-12s${C_RESET} %s\n" "GPU:"      "$gpu"
printf "${C_LABEL}%-12s${C_RESET} %s\n" "Memory:"   "$mem_str"
printf "${C_LABEL}%-12s${C_RESET} %s\n" "Disk (/):" "$d_used / $d_total ($d_percent)"
echo -e "${C_HEAD}------------------------------------------${C_RESET}"
